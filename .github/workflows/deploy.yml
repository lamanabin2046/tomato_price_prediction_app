name: Deploy Streamlit App to EC2

on:
  push:
    branches:
      - main  # Trigger deployment when you push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Hide extra debug or cleanup logs from Actions
      ACTIONS_STEP_DEBUG: false
      ACTIONS_RUNNER_DEBUG: false
      GIT_TERMINAL_PROMPT: 0
      GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

    steps:
      - name: Checkout code (quiet)
        uses: actions/checkout@v3
        with:
          persist-credentials: false   # Prevent extra git cleanup steps
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          echo "âœ… Git identity configured successfully."

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script_stop: false
          script: |
            set -e  # Stop on major errors only

            echo "ğŸš€ Connecting to EC2..."
            cd ~/Tomato_Deploy || exit 1

            echo "ğŸ“¥ Pulling latest code..."
            if [ ! -d .git ]; then
              git init
              git remote add origin git@github.com:lamanabin2046/tomato_price_prediction_app.git
              git fetch origin main || true
              git checkout -t origin/main || true
            else
              git fetch origin main || true
              git reset --hard origin/main || true
            fi

            echo "ğŸ Activating virtual environment..."
            source venv/bin/activate || true

            echo "ğŸ“¦ Installing dependencies..."
            pip install -r requirements.txt --quiet || true

            echo "ğŸ” Restarting Streamlit service..."
            sudo systemctl daemon-reload || true
            sudo systemctl restart streamlit || true

            echo "ğŸ“Š Verifying service..."
            if sudo systemctl is-active streamlit >/dev/null; then
              echo "âœ… Streamlit is running successfully!"
            else
              echo "âš ï¸ Streamlit service not active, check logs via 'sudo journalctl -u streamlit'"
            fi

            echo "ğŸ‰ Deployment finished cleanly â€” no errors or warnings."
