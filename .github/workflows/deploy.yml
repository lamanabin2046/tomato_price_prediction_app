name: Deploy Dash App to EC2

on:
  push:
    branches:
      - main  # Trigger deployment on pushes to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      GIT_TERMINAL_PROMPT: 0
      GIT_SSH_COMMAND: "ssh -o StrictHostKeyChecking=no"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions Bot"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script_stop: false
          script: |
            set -e
            echo "ğŸš€ Connecting to EC2 and deploying Dash app..."

            cd ~/Tomato_Deploy || exit 1

            echo "ğŸ“¥ Pulling latest code..."
            if [ ! -d .git ]; then
              git init
              git remote add origin git@github.com:lamanabin2046/tomato_price_prediction_app.git
              git fetch origin main
              git checkout -t origin/main
            else
              git fetch origin main
              git reset --hard origin/main
            fi

            echo "ğŸ Activating virtual environment..."
            source venv/bin/activate || python3 -m venv venv && source venv/bin/activate

            echo "ğŸ“¦ Installing/updating dependencies..."
            pip install -r requirements.txt --quiet

            echo "âš™ï¸ Restarting Dash service..."
            sudo systemctl daemon-reload || true
            sudo systemctl restart dashapp || true

            echo "ğŸ“Š Checking Dash service status..."
            if sudo systemctl is-active dashapp >/dev/null; then
              echo "âœ… Dash app running successfully!"
            else
              echo "âš ï¸ Dash service inactive â€” check logs with:"
              echo "sudo journalctl -u dashapp -f"
            fi

            echo "ğŸ‰ Deployment completed successfully!"
